<script>
    let currentSeriesData = {};

    // Esta fun√ß√£o ser√° usada apenas por s√©ries como The 100
    function generateThe100Code(season, episode) {
        const seasonStr = season.toString().padStart(2, '0');
        const episodeStr = episode.toString().padStart(2, '0');
        return `THE100S${seasonStr}EP${episodeStr}`;
    }

    function updateSeasonOptions(database) {
        const seasonSelect = document.getElementById('season');
        seasonSelect.innerHTML = '';
        Object.keys(database).forEach(seasonNum => {
            const option = document.createElement('option');
            option.value = seasonNum;
            option.textContent = `Temporada ${seasonNum}`;
            seasonSelect.appendChild(option);
        });
    }
    function updateEpisodes() {
        const seasonNum = parseInt(document.getElementById('season').value);
        const episodeSelect = document.getElementById('episode');
        const episodes = currentSeriesData.database[seasonNum].episodes;
        episodeSelect.innerHTML = '';
        episodes.forEach(ep_data => {
            const option = document.createElement('option');
            option.value = ep_data.ep;
            option.textContent = `Epis√≥dio ${ep_data.ep}: ${ep_data.title}`;
            episodeSelect.appendChild(option);
        });
        updateSeasonInfo();
    }
    function updateSeasonInfo() {
        const seasonNum = parseInt(document.getElementById('season').value);
        const maxEpisodes = currentSeriesData.database[seasonNum].episodes.length;
        document.getElementById('seasonInfo').textContent = `Temporada ${seasonNum} - ${maxEpisodes} Epis√≥dios`;
    }
    function updateEpisodeGrid() {
        const seasonNum = parseInt(document.getElementById('season').value);
        const currentEpisode = parseInt(document.getElementById('episode').value);
        const episodes = currentSeriesData.database[seasonNum].episodes;
        const gridContainer = document.getElementById('episodeGrid');
        gridContainer.innerHTML = '';
        episodes.forEach(ep_data => {
            const episodeDiv = document.createElement('div');
            episodeDiv.className = 'episode-item';
            episodeDiv.title = ep_data.title;
            episodeDiv.textContent = `EP ${ep_data.ep}`;
            if (ep_data.ep === currentEpisode) {
                episodeDiv.classList.add('active');
            }
            episodeDiv.onclick = () => {
                document.getElementById('episode').value = ep_data.ep;
                loadEpisode();
            };
            gridContainer.appendChild(episodeDiv);
        });
    }
    function loadEpisode() {
        const seasonNum = parseInt(document.getElementById('season').value);
        const episodeNum = parseInt(document.getElementById('episode').value);
        const episodeData = currentSeriesData.database[seasonNum].episodes.find(e => e.ep == episodeNum);
        if (!episodeData) return;

        let newUrl = '';

        // L√ìGICA NOVA: Decide como montar a URL com base nos dados da s√©rie
        if (currentSeriesData.url_pattern) {
            // Se tiver um 'url_pattern', usa o padr√£o novo (para Ahsoka)
            newUrl = currentSeriesData.url_pattern + episodeData.id;
        } else {
            // Sen√£o, usa o padr√£o antigo (para The 100)
            const serverName = episodeData.server;
            const episodeCode = generateThe100Code(seasonNum, episodeNum);
            newUrl = `//redecanais.gd/player3/server.php?server=${serverName}&subfolder=ondemand&vid=${episodeCode}`;
        }
        
        document.getElementById('playerFrame').src = newUrl;
        document.getElementById('currentEpisode').textContent = `T${seasonNum}:E${episodeNum} - ${episodeData.title}`;
        
        // Atualiza o bot√£o de "Abrir V√≠deo" para mobile
        const watchButton = document.getElementById('watchButton');
        if(watchButton) watchButton.href = newUrl;

        updateEpisodeGrid();
    }
    function nextEpisode() {
        const seasonNum = parseInt(document.getElementById('season').value);
        let episodeNum = parseInt(document.getElementById('episode').value);
        const maxEpisodes = currentSeriesData.database[seasonNum].episodes.length;
        if (episodeNum < maxEpisodes) {
            document.getElementById('episode').value = episodeNum + 1;
            loadEpisode();
        } else if (seasonNum < Object.keys(currentSeriesData.database).length) {
            document.getElementById('season').value = parseInt(seasonNum) + 1;
            updateEpisodes();
            document.getElementById('episode').value = 1;
            loadEpisode();
        } else {
            alert('Voc√™ chegou ao final da s√©rie! üéâ');
        }
    }
    function previousEpisode() {
        const seasonNum = parseInt(document.getElementById('season').value);
        let episodeNum = parseInt(document.getElementById('episode').value);
        if (episodeNum > 1) {
            document.getElementById('episode').value = episodeNum - 1;
            loadEpisode();
        } else if (seasonNum > 1) {
            const prevSeason = seasonNum - 1;
            document.getElementById('season').value = prevSeason;
            updateEpisodes();
            const maxEpisodesPrevSeason = currentSeriesData.database[prevSeason].episodes.length;
            document.getElementById('episode').value = maxEpisodesPrevSeason;
            loadEpisode();
        } else {
            alert('Voc√™ est√° no primeiro epis√≥dio da s√©rie! üèÅ');
        }
    }
    document.addEventListener('DOMContentLoaded', () => {
        const params = new URLSearchParams(window.location.search);
        const serieId = params.get('serie');
        if (serieId) {
            const script = document.createElement('script');
            script.src = `data/${serieId}.js`;
            script.onload = () => {
                currentSeriesData = window.seriesData;
                document.title = `${currentSeriesData.title} - Player`;
                document.getElementById('seriesTitle').textContent = `${currentSeriesData.title}`;
                document.getElementById('player-container-main').style.display = 'block';
                setupPlayer();
            };
            script.onerror = () => { document.body.innerHTML = `<h1>Erro: N√£o foi poss√≠vel carregar os dados para a s√©rie "${serieId}". Verifique se o arquivo "data/${serieId}.js" existe.</h1>`; };
            document.body.appendChild(script);
        } else {
            document.body.innerHTML = '<h1>Nenhuma s√©rie selecionada. Volte para o menu principal.</h1>';
        }
    });
    function setupPlayer() {
        updateSeasonOptions(currentSeriesData.database);
        document.getElementById('season').value = 1;
        document.getElementById('season').addEventListener('change', () => {
            updateEpisodes();
            document.getElementById('episode').value = 1;
            loadEpisode();
        });
        document.getElementById('loadEpisodeBtn').addEventListener('click', loadEpisode);
        document.getElementById('prevEpisodeBtn').addEventListener('click', previousEpisode);
        document.getElementById('nextEpisodeBtn').addEventListener('click', nextEpisode);
        document.addEventListener('keydown', function(event) {
            if (event.key === 'ArrowRight') nextEpisode(); 
            else if (event.key === 'ArrowLeft') previousEpisode();
        });
        updateEpisodes();
        loadEpisode();
    }
</script>
